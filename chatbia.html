<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatBI – Dashboard Interactif Pro</title>
  <!-- Bootstrap CSS pour layout pro -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts: Inter (moderne comme Power BI) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <!-- Chart.js avec zoom -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #2c3e50; }
    
    /* Header global (comme Power BI: barre bleue avec logo et user) */
    .header { background: linear-gradient(90deg,#005ea8 0%, #0078d4 100%); color: white; box-shadow: 0 2px 14px rgba(0,0,0,0.12); }
    .logo { font-weight: 700; font-size: 1.4rem; }
    .nav-link { color: rgba(255,255,255,0.8); }
    .nav-link:hover { color: white; }

    /* Left Nav Pane: Inspiré de Power BI (Home, Workspaces, etc.) */
    .left-nav { 
      background-color: #ffffff; 
      border-right: 1px solid #dee2e6; 
      height: 100vh; 
      position: fixed; 
      left: 0; 
      top: 0; 
      width: 250px; 
      overflow-y: auto; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
      transition: width 0.18s ease, left 0.18s ease, transform 0.28s ease;
      z-index: 105;
    }
    /* left-nav collapsed state */
    .left-nav.collapsed { width: 72px; }
    .left-nav .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.9rem; }
    .left-nav .nav-item .nav-label { display: inline-block; }
    .left-nav.collapsed .nav-item .nav-label { display: none; }
    /* resizer handle */
    .left-resizer { position: absolute; right: -6px; top: 0; bottom: 0; width: 12px; cursor: ew-resize; z-index: 106; }
  .nav-item { cursor: pointer; border-bottom: 1px solid #f8f9fa; transition: background 0.2s; }
  .nav-item:hover { background-color: #f1f5f8; }
  .nav-item.active { background: linear-gradient(90deg, rgba(0,120,212,0.12), rgba(0,120,212,0.02)); color: #073b5a; }
    .nav-section { font-weight: 600; color: #6c757d; padding: 0.5rem 1rem; margin-top: 1rem; text-transform: uppercase; font-size: 0.8rem; }

    /* Main Content Area */
    .main-content { margin-left: 250px; padding: 2rem; }
    .top-nav { 
      background: white; 
      border-bottom: 1px solid #dee2e6; 
      padding: 0.75rem 1rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 2rem; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }

    /* Tabs en bas pour pages report (comme Power BI: onglets horizontaux en bas du canvas) */
    .report-canvas { 
      background: white; 
      border-radius: 8px; 
      overflow: hidden; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
      min-height: 70vh; 
      position: relative; 
    }
    .report-tabs { 
      display: flex; 
      background: #f8f9fa; 
      border-top: 1px solid #dee2e6; 
      position: absolute; 
      bottom: 0; 
      left: 0; 
      right: 0; 
    }
    .tab-item { 
      padding: 0.75rem 1.5rem; 
      cursor: pointer; 
      border-right: 1px solid #dee2e6; 
      transition: background 0.2s; 
      white-space: nowrap; 
    }
    .tab-item:hover, .tab-item.active { background: white; font-weight: 500; }
    .tab-content { padding: 2rem; height: calc(100% - 60px); overflow-y: auto; }

    /* Right Pane: Fields et Filters (comme Power BI, toggleable) */
    .right-pane { 
      position: fixed; 
      right: -300px; 
      top: 0; 
      width: 300px; 
      height: 100vh; 
      background: white; 
      border-left: 1px solid #dee2e6; 
      transition: right 0.3s; 
      overflow-y: auto; 
      box-shadow: -4px 0 20px rgba(0,0,0,0.05); 
      z-index: 100; 
    }
    .right-pane.open { right: 0; }
    .toggle-pane { cursor: pointer; position: fixed; right: 0; top: 50%; background: #0078d4; color: white; padding: 0.5rem; border-radius: 4px 0 0 4px; z-index: 101; }

    /* Chat intégré dans une page (comme un visual) */
    .chat-section { height: 500px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
    .chat-header { background-color: #e9ecef; font-weight: 600; color: #0078d4; padding: 0.75rem; }
    .chat-messages { height: 350px; overflow-y: auto; padding: 1rem; background: white; }
    .message { max-width: 75%; padding: 0.75rem 1.25rem; border-radius: 20px; margin-bottom: 1rem; }
    .user { background-color: #d1eaff; align-self: flex-end; margin-left: auto; }
    .bot { background-color: #f8f9fa; align-self: flex-start; }
    .chat-input { padding: 1rem; border-top: 1px solid #dee2e6; background: white; display: flex; gap: 0.5rem; }
    .send-btn { background-color: #0078d4; border: none; color: white; border-radius: 50%; width: 40px; height: 40px; }

    /* Dashboard elements: KPI, Tableau, Chart */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .kpi-card { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); background: linear-gradient(135deg, #ffffff, #f8f9fa); padding: 1.5rem; text-align: center; }
    .kpi-value { font-size: 2rem; font-weight: 600; color: #0078d4; }
    .filters-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .data-table { font-size: 0.9rem; }
    .data-table th { background-color: #f1f3f5; position: sticky; top: 0; z-index: 2; }
    .chart-container { height: 400px; position: relative; margin-top: 1rem; }

    /* Pages spécifiques */
    .page-import { padding: 2rem; }
    .page-preparation { padding: 2rem; }
    .page-dashboard { /* Contenu principal dashboard */ }

    /* Responsive: Masquer left nav sur mobile */
    @media (max-width: 992px) {
      .left-nav { transform: translateX(-100%); transition: transform 0.3s; }
      .left-nav.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
      .right-pane { right: -100%; width: 100%; }
      .report-tabs { flex-direction: column; }
    }

    /* Chatbot global (sidebar droite) */
    .chatbot-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      /* bleu fondu vibrant (choix: bleu harmonique) */
      background: linear-gradient(135deg,#005ea8 0%, #0078d4 60%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 34px rgba(2,6,23,0.45), 0 0 28px rgba(0,120,212,0.06);
      z-index: 1300;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .chatbot-toggle:hover { transform: translateY(-2px); box-shadow: 0 14px 44px rgba(2,6,23,0.5), 0 0 40px rgba(0,120,212,0.08); }
    .chatbot-toggle:focus { outline: 3px solid rgba(0,120,212,0.18); }

    .chatbot-sidebar {
      position: fixed;
      top: 0;
      right: -420px;
      width: 380px;
      height: 100vh;
      /* bleu fondu harmonique */
      background: linear-gradient(180deg,#023556 0%, #006fbf 55%, #0a2a3b 100%);
      color: #e6eef8;
      box-shadow: -20px 0 50px rgba(2,6,23,0.5);
      border-left: 1px solid rgba(255,255,255,0.04);
      transition: right 0.32s ease, width 0.16s ease;
      z-index: 1299;
      display: flex;
      flex-direction: column;
      min-width: 280px;
      max-width: 640px;
    }
    .chatbot-sidebar.open { right: 0; }
    .cb-header { border-bottom: 1px solid rgba(255,255,255,0.04); background: transparent; color: #e6eef8; }
    .cb-header strong { font-size: 1rem; }
    .cb-header .cb-header-actions .btn-icon { background: transparent; border: 1px solid rgba(255,255,255,0.03); color: #cfe6ff; }
    .cb-header .cb-header-actions .btn-icon:hover { background: rgba(255,255,255,0.02); }

    .cb-messages { flex: 1; overflow-y: auto; padding: 1rem; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .cb-input { border-top: 1px solid rgba(255,255,255,0.03); background: transparent; padding: 1rem; }

    .cb-message { display: flex; gap: 0.6rem; align-items: flex-end; margin-bottom: 0.75rem; }
    .cb-avatar { width: 36px; height: 36px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    .cb-message .cb-text { padding: 0.55rem 0.9rem; border-radius: 12px; max-width: 78%; line-height: 1.2; }
    .cb-message.user { justify-content: flex-end; }
  .cb-message.user .cb-avatar { background: linear-gradient(135deg,#1e3a8a,#2563eb); color: white; order: 2; }
    .cb-message.user .cb-text { background: linear-gradient(180deg,#062b52,#093a6b); color: #e6f6ff; order: 1; }
    .cb-message.bot .cb-avatar { background: rgba(255,255,255,0.03); color: #cfe6ff; }
    .cb-message.bot .cb-text { background: rgba(255,255,255,0.03); color: #dbeffd; }
    .cb-typing { font-style: italic; color: #9fb3d6; }

    /* Response box (rectangle encadré, joli contour) */
    .cb-response-box {
      margin: 0.75rem 1rem; padding: 0.75rem; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 8px 22px rgba(2,6,23,0.28);
      color: #dbeffd; font-size: 0.95rem;
    }
    .cb-response-box h6 { margin: 0 0 0.4rem 0; font-size: 0.9rem; color: #cfe6ff; }

    /* Resizer: draggable vertical handle to change width */
    .chat-resizer { position: absolute; left: -6px; top: 0; bottom: 0; width: 12px; cursor: ew-resize; z-index: 1301; }

    /* Collapsed state: narrow, only header icons visible */
    .chatbot-sidebar.collapsed { width: 72px !important; }
    .chatbot-sidebar.collapsed .cb-messages,
    .chatbot-sidebar.collapsed .cb-input,
    .chatbot-sidebar.collapsed .cb-response-box,
    .chatbot-sidebar.collapsed .cb-header .text-muted { display: none; }
    .chatbot-sidebar.collapsed .cb-header { padding-left: 8px; padding-right: 8px; }
    .chatbot-sidebar.collapsed .cb-header strong { display: block; transform: none; font-size: 0.88rem; }
    .chatbot-sidebar.collapsed .cb-header .cb-header-actions { display: none; }


    /* small icon button used in header */
    .btn-icon { width: 36px; height: 36px; padding: 0.375rem; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; }

  </style>
</head>
<body>

  <!-- Top Menu Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-1">
    <div class="container-fluid px-3">
      <div class="navbar-nav me-auto">
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="fileMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Fichier
          </a>
          <ul class="dropdown-menu" aria-labelledby="fileMenu">
            <li><a class="dropdown-item" href="#"><i class="fas fa-plus me-2"></i>Nouveau</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-folder-open me-2"></i>Ouvrir</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-save me-2"></i>Enregistrer</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-save me-2"></i>Enregistrer sous</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i>Quitter</a></li>
          </ul>
        </div>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="editMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Édition
          </a>
          <ul class="dropdown-menu" aria-labelledby="editMenu">
            <li><a class="dropdown-item" href="#"><i class="fas fa-undo me-2"></i>Annuler</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-redo me-2"></i>Rétablir</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-cut me-2"></i>Couper</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-copy me-2"></i>Copier</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-paste me-2"></i>Coller</a></li>
          </ul>
        </div>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="viewMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Affichage
          </a>
          <ul class="dropdown-menu" aria-labelledby="viewMenu">
            <li><a class="dropdown-item" href="#"><i class="fas fa-search-plus me-2"></i>Zoom avant</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-search-minus me-2"></i>Zoom arrière</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-expand me-2"></i>Plein écran</a></li>
            <li><a class="dropdown-item" href="#" id="toggleLeftNavDesktop"><i class="fas fa-bars me-2"></i>Navigation</a></li>
          </ul>
        </div>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="toolsMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Outils
          </a>
          <ul class="dropdown-menu" aria-labelledby="toolsMenu">
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Paramètres</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-plug me-2"></i>Extensions</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-terminal me-2"></i>Console</a></li>
          </ul>
        </div>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="helpMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Aide
          </a>
          <ul class="dropdown-menu" aria-labelledby="helpMenu">
            <li><a class="dropdown-item" href="#"><i class="fas fa-question-circle me-2"></i>Documentation</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-info-circle me-2"></i>À propos</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-envelope me-2"></i>Contact</a></li>
          </ul>
        </div>
      </div>
      <div class="d-flex gap-3">
        <a href="#" class="nav-link text-light"><i class="fas fa-bell"></i></a>
        <a href="#" class="nav-link text-light">Profil</a>
        <a href="#" class="nav-link text-light">Déconnexion</a>
      </div>
    </div>
  </nav>

  <!-- Header global -->
  <header class="header py-2 px-4 d-flex justify-content-between align-items-center">
    <div class="logo d-flex align-items-center gap-2">
      <i class="fas fa-chart-line"></i> ChatBI
    </div>
  </header>

  <!-- Left Navigation Pane (comme Power BI: Home, Workspaces, etc.) -->
  <nav class="left-nav">
    <div id="leftResizer" class="left-resizer" aria-hidden="true"></div>
    <div class="nav-header d-flex justify-content-between align-items-center p-3 border-bottom">
      <div class="logo d-flex align-items-center gap-2">
        <i class="fas fa-chart-line"></i> ChatBI
      </div>
      <button id="toggleLeftNavDesktop" class="btn btn-sm btn-outline-light" title="Réduire la navigation"><i class="fas fa-bars"></i></button>
    </div>
    <div class="nav-item active" data-page="home"><i class="fas fa-home me-2"></i><span class="nav-label">Accueil</span></div>
    <div class="nav-section">Contenu</div>
    <div class="nav-item" data-page="workspaces"><i class="fas fa-th-large me-2"></i><span class="nav-label">Espaces de travail</span></div>
    <div class="nav-item" data-page="reports"><i class="fas fa-file-alt me-2"></i><span class="nav-label">Rapports</span></div>
    <div class="nav-item" data-page="dashboards"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-label">Tableaux de bord</span></div>
    <div class="nav-section">Données</div>
    <div class="nav-item" data-page="import"><i class="fas fa-upload me-2"></i><span class="nav-label">Importer des données</span></div>
    <div class="nav-item" data-page="sources"><i class="fas fa-database me-2"></i><span class="nav-label">Sources de données</span></div>
    <div class="nav-item" data-page="preparation"><i class="fas fa-edit me-2"></i><span class="nav-label">Préparation des données</span></div>
    <div class="nav-item" data-page="modeling"><i class="fas fa-sitemap me-2"></i><span class="nav-label">Modélisation</span></div>
    <div class="nav-section">Autres</div>
    <div class="nav-item" data-page="apps"><i class="fas fa-layer-group me-2"></i><span class="nav-label">Applications</span></div>
    <div class="nav-item" data-page="learn"><i class="fas fa-book me-2"></i><span class="nav-label">Apprendre</span></div>
    <div class="nav-item" data-page="aide"><i class="fas fa-question-circle me-2"></i><span class="nav-label">Aide</span></div>
  </nav>

  <!-- Toggle pour left nav sur mobile -->
  <button class="btn btn-primary position-fixed top-0 start-0 m-3 d-lg-none" id="toggleLeftNav"><i class="fas fa-bars"></i></button>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Navigation (comme Power BI: Recherche, Notifications, etc.) -->
    <div class="top-nav">
      <div class="d-flex align-items-center gap-3">
        <input type="text" class="form-control" placeholder="Rechercher..." style="width: 300px;">
        <button class="btn btn-outline-secondary"><i class="fas fa-plus"></i> Nouveau</button>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" id="toggleRightPane"><i class="fas fa-filter"></i> Filtres</button>
        <span id="currentPageTitle">Accueil</span>
      </div>
    </div>

    <!-- Report Canvas (zone où les graphiques s'affichent exactement comme Power BI: blanc, paddé, avec tabs en bas) -->
    <div class="report-canvas">
      <!-- Contenu des pages -->
      <div id="pageContent">
        <!-- Page Accueil: Intro avec Chat -->
        <div id="page-home" class="tab-content page-dashboard">
          <h3>Bienvenue dans ChatBI</h3>
          <p>Utilisez le chat pour analyser vos données en temps réel.</p>
          <!-- Chat accessible via le bouton global en haut à droite -->
          <div class="mb-3">
            <small>Le chatbot professionnel est disponible via le bouton fixe en haut à droite.</small>
          </div>
          <!-- Exemple Graphique -->
          <div class="chart-container">
            <canvas id="salesChart"></canvas>
          </div>
        </div>

        <!-- Page Importer des données -->
        <div id="page-import" class="tab-content page-import d-none">
          <h3>Importer des données</h3>
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5>Depuis un fichier</h5>
                  <button class="btn btn-primary"><i class="fas fa-upload"></i> Sélectionner fichier (CSV, Excel)</button>
                  <p class="text-muted">Supporte CSV, Excel, JSON, etc.</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5>Depuis une base de données</h5>
                  <select class="form-select mb-2">
                    <option>SQL Server</option>
                    <option>PostgreSQL</option>
                    <option>BigQuery</option>
                  </select>
                  <button class="btn btn-primary">Connecter</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Page Sources de données -->
        <div id="page-sources" class="tab-content d-none">
          <h3>Sources de données connectées</h3>
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div><i class="fas fa-database me-2"></i>SQL Server - VentesDB</div>
              <button class="btn btn-sm btn-outline-danger">Déconnecter</button>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div><i class="fas fa-file-excel me-2"></i>Excel - RapportMensuel.xlsx</div>
              <button class="btn btn-sm btn-outline-danger">Supprimer</button>
            </div>
          </div>
          <button class="btn btn-primary mt-3"><i class="fas fa-plus"></i> Ajouter une source</button>
        </div>

        <!-- Page Préparation des données -->
        <div id="page-preparation" class="tab-content page-preparation d-none">
          <h3>Préparation des données (Power Query)</h3>
          <div class="row">
            <div class="col-md-4">
              <h6>Colonnes</h6>
              <ul class="list-unstyled">
                <li class="d-flex justify-content-between"><span>Région</span><i class="fas fa-arrow-up text-primary"></i></li>
                <li>Ventes</li>
                <li>Date</li>
              </ul>S
            </div>
            <div class="col-md-8">
              <h6>Transformations appliquées</h6>
              <div class="list-group">
                <div class="list-group-item"><i class="fas fa-filter me-2"></i>Filtré par année 2025</div>
                <div class="list-group-item"><i class="fas fa-sort me-2"></i>Trié par ventes</div>
              </div>
              <button class="btn btn-success mt-2"><i class="fas fa-play"></i> Appliquer & Fermer</button>
            </div>
          </div>
        </div>

        <!-- Page Modélisation -->
        <div id="page-modeling" class="tab-content d-none">
          <h3>Modélisation</h3>
          <p>Relations entre tables: Ventes → Régions (1:N)</p>
          <div class="alert alert-info">Aucune mesure DAX personnalisée pour l'instant.</div>
          <button class="btn btn-primary">Nouvelle mesure</button>
        </div>

        <!-- Autres pages similaires... -->
      </div>

      <!-- Onglets en bas (comme Power BI) -->
      <div class="report-tabs">
        <div class="tab-item active" data-tab="home">Accueil</div>
        <div class="tab-item" data-tab="import">Import</div>
        <div class="tab-item" data-tab="sources">Sources</div>
        <div class="tab-item" data-tab="preparation">Préparation</div>
        <div class="tab-item" data-tab="modeling">Modélisation</div>
        <div class="tab-item" data-tab="dashboard">Dashboard <i class="fas fa-plus-circle" style="font-size: 0.8rem;"></i></div>
      </div>
    </div>
  </main>

  <!-- Right Pane: Fields et Filters (comme Power BI) -->
  <div class="right-pane" id="rightPane">
    <div class="p-3 border-bottom">
      <h6>Filtres & Champs</h6>
      <button class="btn btn-sm btn-outline-secondary float-end" id="closeRightPane"><i class="fas fa-times"></i></button>
    </div>
    <div class="p-3">
      <!-- Filtres -->
      <h6>Filtres</h6>
      <div class="filters-row">
        <select class="form-select">
          <option>Région</option>
        </select>
        <input type="range" class="form-range" min="0" max="100">
      </div>
      <!-- Champs -->
      <h6 class="mt-3">Champs</h6>
      <ul class="list-unstyled">
        <li><i class="fas fa-check text-success me-2"></i>Ventes</li>
        <li><i class="fas fa-times text-danger me-2"></i>Date</li>
      </ul>
    </div>
  </div>
  <div class="toggle-pane" id="toggleRightPaneIcon"><i class="fas fa-chevron-left"></i></div>

  <!-- Global Chatbot: toggle button + sidebar (apparaît sur toutes les pages) -->
  <button id="chatbotToggle" class="chatbot-toggle" aria-controls="chatbotSidebar" aria-expanded="false" title="Ouvrir le chatbot">
    <i class="fas fa-comments" aria-hidden="true"></i>
  </button>

  <aside id="chatbotSidebar" class="chatbot-sidebar" aria-hidden="true">
    <div class="cb-header d-flex justify-content-between align-items-center p-3">
      <div>
        <strong>Assistant ChatBI</strong>
        <div class="text-muted" style="font-size:0.75rem;color:rgba(207,230,255,0.6);">Analyse & requêtes rapides</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="cb-header-actions d-flex gap-2 me-2">
          <button title="Historique" class="btn btn-icon" id="cbHistory"><i class="fas fa-history"></i></button>
          <button title="Réglages" class="btn btn-icon" id="cbSettings"><i class="fas fa-cog"></i></button>
          <button title="Exporter" class="btn btn-icon" id="cbExport"><i class="fas fa-download"></i></button>
        </div>
        <button id="chatbotClose" class="btn btn-sm btn-outline-secondary" aria-label="Fermer le chat"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <div id="chatResizer" class="chat-resizer" aria-hidden="true"></div>
    <div id="cbResponseBox" class="cb-response-box" aria-live="polite" aria-atomic="true">
      <h6>Réponse rapide</h6>
      <div id="cbResponseContent">Les réponses synthétiques s'affichent ici (ex: résumé, KPI clés).</div>
    </div>
    <div id="cbMessages" class="cb-messages" role="log" aria-live="polite"></div>
    <div class="cb-input p-3 d-flex gap-2">
      <textarea id="cbInput" class="form-control bg-transparent text-light" placeholder="Posez une question..." aria-label="Message au chatbot" rows="1" style="resize: none; overflow: hidden;"></textarea>
      <button id="cbSend" class="btn btn-primary" aria-label="Envoyer le message"><i class="fas fa-paper-plane"></i></button>
      <button id="cbCollapse" class="btn btn-sm btn-outline-light" title="Réduire le chat" aria-pressed="false"> <i class="fas fa-compress-alt"></i> </button>
    </div>
  </aside>

  <!-- Footer -->
  <footer class="text-center py-3 mt-5 text-muted">
    © 2025 ChatBI • v2.0 Pro • Aide • CGU
  </footer>

  <script>
    // Données simulées
    const data = [
      { region: 'Île-de-France', ca: 1240, evolution: '+12%', color: '#0078d4' },
      { region: 'Provence', ca: 890, evolution: '+8%', color: '#28a745' },
      { region: 'Nouvelle-Aquitaine', ca: 720, evolution: '-3%', color: '#dc3545' },
      { region: 'Occitanie', ca: 680, evolution: '+5%', color: '#ffc107' },
      { region: 'Auvergne-Rhône-Alpes', ca: 950, evolution: '+15%', color: '#6f42c1' }
    ];

    // Navigation Left Nav
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        const page = item.dataset.page;
        document.getElementById('currentPageTitle').textContent = item.textContent.trim();
        // Load page content (ici, simulation via tabs)
        switch(page) {
          case 'import': loadPage('import'); break;
          case 'sources': loadPage('sources'); break;
          case 'preparation': loadPage('preparation'); break;
          case 'modeling': loadPage('modeling'); break;
          default: loadPage('home');
        }
      });
    });

    // Onglets en bas (comme Power BI)
    document.querySelectorAll('.tab-item').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabId = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('d-none'));
        document.getElementById(`page-${tabId}`).classList.remove('d-none');
      });
    });

    function loadPage(pageKey) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('d-none'));
      const pageEl = document.getElementById(`page-${pageKey}`);
      if (pageEl) pageEl.classList.remove('d-none');
      // Update tabs active si besoin
      const tab = document.querySelector(`[data-tab="${pageKey}"]`);
      if (tab) {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      }
    }

    // Toggle Left Nav mobile
    document.getElementById('toggleLeftNav').addEventListener('click', () => {
      document.querySelector('.left-nav').classList.toggle('open');
    });

    // Desktop: collapse & resizer for left-nav (dynamic like chatbot)
    (function(){
      const leftNav = document.querySelector('.left-nav');
      const leftResizerEl = document.getElementById('leftResizer');
      const toggleLeftNavDesktop = document.getElementById('toggleLeftNavDesktop');
      const mainContentEl = document.querySelector('.main-content');

      function applyLeftNavWidth(w){
        leftNav.style.width = w + 'px';
        if(mainContentEl) mainContentEl.style.marginLeft = w + 'px';
      }

      // restore persisted state
      try{
        const collapsed = localStorage.getItem('leftNavCollapsed') === '1';
        const storedW = parseInt(localStorage.getItem('leftNavWidth'));
        if(collapsed){ leftNav.classList.add('collapsed'); if(mainContentEl) mainContentEl.style.marginLeft = '72px'; }
        else if(storedW && !isNaN(storedW)){ applyLeftNavWidth(storedW); }
      }catch(e){}

      // toggle collapse
      if(toggleLeftNavDesktop){
        toggleLeftNavDesktop.addEventListener('click', () => {
          const isCollapsed = leftNav.classList.toggle('collapsed');
          localStorage.setItem('leftNavCollapsed', isCollapsed ? '1' : '0');
          if(isCollapsed){ if(mainContentEl) mainContentEl.style.marginLeft = '72px'; }
          else { const w = parseInt(localStorage.getItem('leftNavWidth')) || 250; applyLeftNavWidth(w); }
        });
      }

      // resizer drag
      if(leftResizerEl){
        let dragging = false, startX = 0, startW = 0;
        const minW = 180, maxW = 480;
        leftResizerEl.addEventListener('mousedown', (e) => {
          e.preventDefault();
          dragging = true; startX = e.clientX; startW = leftNav.getBoundingClientRect().width;
          document.body.style.userSelect = 'none';
        });
        window.addEventListener('mousemove', (e) => {
          if(!dragging) return;
          const dx = e.clientX - startX; // moving right increases width
          let newW = Math.round(startW + dx);
          if(newW < minW) newW = minW; if(newW > maxW) newW = maxW;
          leftNav.classList.remove('collapsed');
          applyLeftNavWidth(newW);
          try{ localStorage.setItem('leftNavWidth', String(newW)); localStorage.setItem('leftNavCollapsed', '0'); }catch(err){}
        });
        window.addEventListener('mouseup', () => { if(dragging){ dragging = false; document.body.style.userSelect = ''; } });
      }
    })();

    // Right Pane Toggle
    document.getElementById('toggleRightPane').addEventListener('click', () => {
      document.getElementById('rightPane').classList.toggle('open');
      document.getElementById('toggleRightPaneIcon').style.display = 'none';
    });
    document.getElementById('closeRightPane').addEventListener('click', () => {
      document.getElementById('rightPane').classList.remove('open');
      document.getElementById('toggleRightPaneIcon').style.display = 'block';
    });
    document.getElementById('toggleRightPaneIcon').addEventListener('click', () => {
      document.getElementById('rightPane').classList.toggle('open');
    });

    // Global Chatbot (sidebar) — remplace l'ancien chat intégré
  const chatbotToggle = document.getElementById('chatbotToggle');
  const chatbotSidebar = document.getElementById('chatbotSidebar');
  const chatbotClose = document.getElementById('chatbotClose');
  const cbMessages = document.getElementById('cbMessages');
  const cbInput = document.getElementById('cbInput');
  const cbSend = document.getElementById('cbSend');
  const cbResponseContent = document.getElementById('cbResponseContent');
  const cbResponseBox = document.getElementById('cbResponseBox');
  const chatResizer = document.getElementById('chatResizer');
  const cbCollapse = document.getElementById('cbCollapse');

    function openChat() {
      chatbotSidebar.classList.add('open');
      chatbotToggle.setAttribute('aria-expanded', 'true');
      chatbotSidebar.setAttribute('aria-hidden', 'false');
      setTimeout(() => cbInput.focus(), 200);
    }
    function closeChat() {
      chatbotSidebar.classList.remove('open');
      chatbotToggle.setAttribute('aria-expanded', 'false');
      chatbotSidebar.setAttribute('aria-hidden', 'true');
      chatbotToggle.focus();
    }

    chatbotToggle.addEventListener('click', () => {
      if (chatbotSidebar.classList.contains('open')) closeChat(); else openChat();
    });
    chatbotClose.addEventListener('click', closeChat);
    cbSend.addEventListener('click', handleSend);
    cbInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
    cbInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });
    cbCollapse.addEventListener('click', () => {
      const isCollapsed = chatbotSidebar.classList.toggle('collapsed');
      cbCollapse.setAttribute('aria-pressed', String(isCollapsed));
      // If collapsed, shrink and keep toggle visible
      if (isCollapsed) {
        chatbotSidebar.setAttribute('aria-hidden', 'false');
      } else {
        chatbotSidebar.setAttribute('aria-hidden', String(!chatbotSidebar.classList.contains('open')));
      }
    });

    // Resizer: drag to resize width
    (function() {
      let dragging = false;
      let startX = 0;
      let startWidth = 0;
      const minW = 260;
      const maxW = 640;
      chatResizer.addEventListener('mousedown', (e) => {
        e.preventDefault(); dragging = true; startX = e.clientX; startWidth = chatbotSidebar.getBoundingClientRect().width;
        document.body.style.userSelect = 'none';
      });
      window.addEventListener('mousemove', (e) => {
        if (!dragging) return;
        const dx = startX - e.clientX; // dragging left increases width
        let newW = startWidth + dx;
        if (newW < minW) newW = minW; if (newW > maxW) newW = maxW;
        chatbotSidebar.style.width = newW + 'px';
        // persist preferred width
        try { localStorage.setItem('chatbotWidth', String(newW)); } catch (err) {}
      });
      window.addEventListener('mouseup', () => { if (dragging) { dragging = false; document.body.style.userSelect = ''; } });
      // restore width
      try {
        const w = parseInt(localStorage.getItem('chatbotWidth'));
        if (w && !isNaN(w)) chatbotSidebar.style.width = Math.max(minW, Math.min(maxW, w)) + 'px';
      } catch (e) {}
    })();

    function appendMessage(text, who = 'bot') {
      const wrapper = document.createElement('div');
      wrapper.className = 'cb-message ' + (who === 'user' ? 'user' : 'bot');

      const avatar = document.createElement('div');
      avatar.className = 'cb-avatar';
      // small icon avatar
      avatar.innerHTML = who === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

      const bubble = document.createElement('div');
      bubble.className = 'cb-text';
      bubble.textContent = text;

      if (who === 'user') {
        // user: text then avatar (order handled by CSS)
        wrapper.appendChild(bubble);
        wrapper.appendChild(avatar);
      } else {
        wrapper.appendChild(avatar);
        wrapper.appendChild(bubble);
      }

      cbMessages.appendChild(wrapper);
      cbMessages.scrollTop = cbMessages.scrollHeight;
      // update response box with a short preview (example behavior)
      try {
        const preview = text.length > 120 ? text.slice(0, 117) + '…' : text;
        document.getElementById('cbResponseContent').textContent = preview;
      } catch (e) {}
    }

    function handleSend() {
      const msg = cbInput.value.trim();
      if (!msg) return;
      appendMessage(msg, 'user');
      cbInput.value = '';

      // typing indicator
      const typingWrapper = document.createElement('div');
      typingWrapper.className = 'cb-message bot cb-typing';
      const tAvatar = document.createElement('div');
      tAvatar.className = 'cb-avatar';
      tAvatar.innerHTML = '<i class="fas fa-robot fa-spin"></i>';
      const tBubble = document.createElement('div');
      tBubble.className = 'cb-text';
      tBubble.textContent = 'IA réfléchit...';
      typingWrapper.appendChild(tAvatar);
      typingWrapper.appendChild(tBubble);
      cbMessages.appendChild(typingWrapper);
      cbMessages.scrollTop = cbMessages.scrollHeight;

      setTimeout(() => {
        typingWrapper.remove();
        appendMessage(`Résultats pour "${msg}" affichés dans le dashboard.`, 'bot');
        // Try updating existing chart if visible
        const homeVisible = !document.getElementById('page-home').classList.contains('d-none');
        if (homeVisible) {
          try { salesChart.update(); } catch (e) { /* chart may not be ready */ }
        }
      }, 1100);
    }

    // Chart (dans canvas comme Power BI)
    const ctx = document.getElementById('salesChart').getContext('2d');
    const salesChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(d => d.region),
        datasets: [{ label: 'Ventes (k€)', data: data.map(d => d.ca), backgroundColor: data.map(d => d.color), borderRadius: 6 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
          zoom: { zoom: { wheel: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy' } }
        },
        scales: { y: { beginAtZero: true, grid: { color: '#e9ecef' } }, x: { grid: { display: false } } }
      }
    });

    // Init
    loadPage('home');
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>